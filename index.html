<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOOM 孵化评估系统 v1.0 (Cloud)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #2c0b0e 0%, #8E0E00 100%);
            --card-bg: #1e1e24;
            --text-main: #fff;
            --text-muted: #aaa;
            --accent: #FFD700; 
            --accent-text: #2c0b0e; 
            --border-color: rgba(255, 215, 0, 0.3);
            --button-bg: #333;
            --grade-s: #FFD700;
            --grade-a: #ff9f43;
            --grade-b: #54a0ff;
            --grade-f: #ff6b6b;
            --border-radius: 8px;
        }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient); color: var(--text-main);
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }

        /* --- Login / Lobby Section --- */
        #loginSection {
            background: var(--card-bg); width: 100%; max-width: 400px;
            padding: 40px; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            z-index: 10;
        }
        .lobby-title { font-size: 1.5rem; font-weight: bold; color: var(--accent); margin-bottom: 30px; }
        .lobby-input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(0,0,0,0.3);
            border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        .lobby-input:focus { border-color: var(--accent); outline: none; }
        .lobby-btn {
            width: 100%; padding: 12px; background: var(--accent); color: var(--accent-text);
            border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: transform 0.1s;
        }
        .lobby-btn:hover { filter: brightness(1.1); }
        .lobby-btn:active { transform: scale(0.98); }

        /* --- Main App Section (Hidden initially) --- */
        #appSection { display: none; width: 100%; max-width: 700px; }

        .container {
            background: var(--card-bg); border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); width: 100%;
            padding: 40px; border: 1px solid var(--border-color); position: relative;
        }

        /* Status Bar */
        .status-bar {
            display: flex; justify-content: space-between; font-size: 0.8rem; color: #888;
            margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .user-tag { color: var(--accent); font-weight: bold; }

        /* Tabs */
        .view-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; background: #333; border: 1px solid #444; color: #aaa;
            cursor: pointer; border-radius: 6px; font-weight: bold; text-align: center;
        }
        .tab-btn.active { background: var(--accent); color: var(--accent-text); border-color: var(--accent); }

        /* Header (Project Name) */
        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 30px; height: 40px;
        }
        .project-title-display {
            font-size: 2rem; font-weight: 800; color: var(--accent); width: 100%;
            border-bottom: 1px solid transparent; padding-bottom: 5px;
        }

        /* Switch */
        .mode-container { display: flex; align-items: center; justify-content: flex-end; width: 40%; }
        .mode-switch {
            display: flex; background: #000; border: 1px solid var(--border-color);
            border-radius: 6px; padding: 4px; position: relative; height: 32px; align-items: center;
        }
        .mode-btn {
            background: transparent; border: none; color: #888; padding: 0 15px;
            cursor: pointer; font-size: 0.85rem; z-index: 2; font-weight: 600; transition: color 0.3s;
        }
        .mode-btn.active { color: var(--accent-text); }
        .slider-bg {
            position: absolute; top: 4px; left: 4px; bottom: 4px; width: calc(50% - 4px);
            background: var(--accent); border-radius: 4px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1;
        }

        /* Dimensions */
        .dimension-row { margin-bottom: 25px; }
        .dim-header { margin-bottom: 6px; font-size: 1.1rem; font-weight: bold; color: #fff; display: flex; justify-content: space-between;}
        .team-avg-display { font-size: 0.9rem; color: var(--grade-b); font-weight: normal; }
        
        .dim-desc {
            font-size: 0.75rem; color: rgba(255, 255, 255, 0.5);
            margin-top: 0; margin-bottom: 10px; padding-left: 1.2em; line-height: 1.4;
        }
        .dim-note-input {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1);
            color: var(--accent); font-size: 0.9rem; padding: 8px 0; margin-top: 8px; outline: none;
            font-family: inherit; transition: border-color 0.3s;
        }
        .dim-note-input:focus { border-bottom: 1px solid var(--accent); }
        .dim-note-input::placeholder { color: rgba(255,255,255,0.2); font-style: italic; }

        .score-selector { display: flex; gap: 4px; height: 36px; }
        .score-btn {
            flex: 1; background: var(--button-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px; color: #888; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .score-btn:hover { background: #444; color: #fff; }
        .score-btn.selected {
            background: var(--accent); color: var(--accent-text); border-color: var(--accent);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
        }
        /* Team view score style */
        .score-btn.team-avg-highlight {
            border: 2px solid var(--grade-b); color: #fff;
        }

        /* Extra Section */
        #extraSection { display: none; margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .extra-group { margin-bottom: 20px; }
        .extra-label { display: block; color: var(--accent); font-size: 0.9rem; margin-bottom: 8px; font-weight: bold; }
        .extra-input {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; color: #fff; padding: 10px; font-size: 0.95rem; font-family: inherit;
            box-sizing: border-box; outline: none;
        }
        textarea.extra-input { resize: vertical; min-height: 80px; }

        /* Actions */
        .action-area { margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;}
        .main-btn {
            background: linear-gradient(to bottom, #FFD700, #FFC000); color: #2c0b0e;
            border: none; padding: 12px 30px; border-radius: 6px; font-size: 1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 0 #b58900;
        }
        .toggle-btn {
            background: #444; color: #fff; border: 1px solid #666;
            padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;
        }
        .secondary-btn {
            background: transparent; border: 2px solid var(--accent); color: var(--accent);
            padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: none;
        }
        .cloud-btn {
            background: #2e86de; color: white; border: none;
            padding: 12px 30px; border-radius: 6px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #1e3799; display: none;
        }

        /* Result */
        .result-section {
            display: none; margin-top: 30px; padding-top: 20px;
            border-top: 1px dashed rgba(255, 255, 255, 0.2); text-align: center;
        }
        .total-score {
            font-size: 4.5rem; font-weight: 800; color: #FFD700 !important;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.2); line-height: 1; margin: 10px 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }
        .grade-badge {
            display: inline-block; padding: 6px 16px; border-radius: 6px;
            font-weight: 900; font-size: 1.5rem; margin-bottom: 15px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .comment {
            font-size: 1rem; color: #ddd !important; background: #333;
            padding: 12px; border-radius: 6px; display: inline-block;
            max-width: 80%; line-height: 1.5; border: 1px solid #444;
        }

        .footer { margin-top: 50px; text-align: center; font-size: 0.7rem; color: rgba(255,255,255,0.15); }
    </style>
</head>
<body>

<!-- Login / Lobby Section -->
<div id="loginSection">
    <div class="lobby-title">BOOOM 孵化评估中心</div>
    <input type="text" id="loginName" class="lobby-input" placeholder="输入你的名字 (如: 小王)" maxlength="10">
    <!-- Datalist for autocomplete -->
    <input type="text" id="loginProject" class="lobby-input" list="projectList" placeholder="输入或选择项目名称">
    <datalist id="projectList"></datalist>
    
    <button class="lobby-btn" onclick="enterApp()">进入 / 创建评估</button>
</div>

<!-- Main Application -->
<div id="appSection">
    <div class="container" id="captureTarget">
        <div class="status-bar">
            <span>当前用户: <span id="displayUser" class="user-tag"></span></span>
            <span id="cloudStatus">未连接云端</span>
        </div>

        <div class="view-tabs">
            <div class="tab-btn active" id="tabMy" onclick="switchTab('my')">我的评分 (编辑模式)</div>
            <div class="tab-btn" id="tabTeam" onclick="switchTab('team')">团队平均 (只读模式)</div>
        </div>

        <div class="header">
            <div class="project-title-display" id="displayProjectName"></div>
            <div class="mode-container">
                <div class="mode-switch" id="modeSwitchControl" onclick="toggleMode()">
                    <div class="slider-bg" id="switchBg"></div>
                    <button class="mode-btn active" id="btnA">玩法驱动</button>
                    <button class="mode-btn" id="btnB">叙事驱动</button>
                </div>
            </div>
        </div>

        <div id="dimensions-container"></div>

        <div id="extraSection">
            <div class="extra-group">
                <label class="extra-label">优点</label>
                <input type="text" class="extra-input" id="extra-pros" placeholder="该项目的亮点如何">
            </div>
            <div class="extra-group">
                <label class="extra-label">缺点</label>
                <input type="text" class="extra-input" id="extra-cons" placeholder="该项目存在的明显缺点与风险">
            </div>
            <div class="extra-group">
                <label class="extra-label">结论</label>
                <input type="text" class="extra-input" id="extra-conclusion" placeholder="是否继续投入精力">
            </div>
            <div class="extra-group">
                <label class="extra-label">希望向团队提的问题</label>
                <textarea class="extra-input" id="extra-questions" placeholder="希望问开发者的问题..."></textarea>
            </div>
        </div>

        <div class="action-area" data-html2canvas-ignore="true">
            <button class="toggle-btn" id="btnAddComment" onclick="toggleExtraSection()">+ 填写评价</button>
            <button class="main-btn" id="btnCalculate" onclick="calculateLocalResult()">计算我的评分</button>
            
            <button class="cloud-btn" id="btnUpload" onclick="uploadToCloud()">☁️ 提交到云端</button>
            <button class="secondary-btn" id="btnSaveImg" onclick="saveImage()">保存报告图片</button>
        </div>

        <div class="result-section" id="resultSection">
            <div style="color: #888; font-size: 0.9rem; text-transform: uppercase;">综合得分</div>
            <div class="total-score" id="finalScore">0.00</div>
            <div id="gradeBadge" class="grade-badge">---</div>
            <div><div class="comment" id="commentText">---</div></div>
        </div>
        
        <div class="footer">© BOOOM Incubation Evaluation System v1.0</div>
    </div>
</div>

<script type="module">
    // --- Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA_bnMNDsBud8xRawWDBYdzuYc8DeG7rQE",
        authDomain: "booom-evaluator.firebaseapp.com",
        projectId: "booom-evaluator",
        storageBucket: "booom-evaluator.firebasestorage.app",
        messagingSenderId: "1047845640626",
        appId: "1:1047845640626:web:909ad83b5d1ad7c77bacab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- State & Config ---
    let currentUser = "";
    let currentProject = "";
    let currentTab = "my"; // 'my' or 'team'
    let teamData = null; // Stores aggregated data

    let config = {
        coeffs: { 10: 1.00, 9: 0.97, 8: 0.80, 7: 0.65, 6: 0.52, 5: 0.35, 4: 0.20, 3: 0.07, 2: 0.02, 1: 0.00 },
        dims: [
            { id: 'core', name: '核心玩法系统', desc: ["游戏的交互体验顺畅...", "核心玩法清晰...", "关卡设计扎实...", "系统深度足够..."] },
            { id: 'narrative', name: '叙事与表现力', desc: ["文本表达易读...", "表现力优异...", "角色个性鲜明...", "节奏合理..."] },
            { id: 'art', name: '审美与艺术表达', desc: ["美术风格突出...", "艺术表达融洽...", "UI易读统一...", "细节质感优秀"] },
            { id: 'originality', name: '游戏独创性', desc: ["玩法风格独特...", "具备独特亮点...", "题材相对小众...", "需要更多案例形容"] },
            { id: 'team', name: '团队沟通与项目能力', desc: ["交流能力正常...", "运行顺畅无Bug...", "路线清晰...", "规模与回报匹配"] },
            { id: 'biz', name: '商业价值与市场潜力', desc: ["商品性强...", "受众人群清晰...", "多平台潜力...", "IP运营潜力"] },
            { id: 'intangible', name: '无形资产', desc: ["卖相是否够好...", "舆论风险与爆款...", "传播性与爆点...", "跨文化障碍"] }
        ],
        weightsA: [26, 12, 10, 13, 19, 14, 6],
        weightsB: [10, 28, 12, 11, 17, 15, 7]
    };

    let currentMode = 'A';
    let myScores = [null, null, null, null, null, null, null]; 
    let extraSectionVisible = false;

    // --- DOM Elements ---
    const loginSection = document.getElementById('loginSection');
    const appSection = document.getElementById('appSection');
    const container = document.getElementById('dimensions-container');
    const resultSection = document.getElementById('resultSection');
    
    // --- Initialization Logic ---

    // 1. Listen for existing projects for autocomplete
    const q = query(collection(db, "projects"));
    const unsubscribe = onSnapshot(q, (querySnapshot) => {
        const datalist = document.getElementById('projectList');
        datalist.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const option = document.createElement('option');
            option.value = doc.id; // Project Name
            datalist.appendChild(option);
        });
    });

    window.enterApp = () => {
        const name = document.getElementById('loginName').value.trim();
        const project = document.getElementById('loginProject').value.trim();

        if(!name || !project) {
            alert("请输入名字和项目名称");
            return;
        }

        currentUser = name;
        currentProject = project;

        // Save local
        localStorage.setItem('booom_user', name);

        // UI Switch
        loginSection.style.display = 'none';
        appSection.style.display = 'block';
        
        document.getElementById('displayUser').innerText = currentUser;
        document.getElementById('displayProjectName').innerText = currentProject;
        document.getElementById('cloudStatus').innerText = "已连接云端";
        document.getElementById('cloudStatus').style.color = "#00ff9d";

        // Init App UI
        renderInputs();
        
        // Load my previous review if exists
        loadMyReview();
        // Listen for team updates
        listenTeamData();
    };

    // Auto-fill name if exists
    const savedName = localStorage.getItem('booom_user');
    if(savedName) document.getElementById('loginName').value = savedName;


    // --- Core App Logic ---

    function renderInputs() {
        container.innerHTML = '';
        config.dims.forEach((dim, index) => {
            const div = document.createElement('div');
            div.className = 'dimension-row';
            const descHtml = dim.desc.map(d => `<li>${d}</li>`).join('');
            
            let buttonsHtml = '';
            for(let i=1; i<=10; i++) {
                buttonsHtml += `<div class="score-btn" id="btn-${index}-${i}" onclick="selectScore(${index}, ${i})">${i}</div>`;
            }

            div.innerHTML = `
                <div class="dim-header">
                    <span>${dim.name}</span>
                    <span class="team-avg-display" id="team-avg-${index}"></span>
                </div>
                <ul class="dim-desc">${descHtml}</ul>
                <div class="score-selector">${buttonsHtml}</div>
                <input type="text" class="dim-note-input" id="dim-input-${index}" placeholder="评分理由..." maxlength="40">
            `;
            container.appendChild(div);
        });
        updateUIFromScores(); // Refresh UI state
    }

    window.selectScore = (dimIndex, scoreVal) => {
        if(currentTab === 'team') return; // Read only
        myScores[dimIndex] = scoreVal;
        updateUIFromScores();
        resetToUncalculatedState();
    };

    function updateUIFromScores() {
        // Clear all selected
        document.querySelectorAll('.score-btn').forEach(b => {
            b.classList.remove('selected', 'selected-low', 'team-avg-highlight');
        });

        // Apply My Scores
        if(currentTab === 'my') {
            myScores.forEach((s, idx) => {
                if(s !== null) {
                    const btn = document.getElementById(`btn-${idx}-${s}`);
                    if(btn) {
                        btn.classList.add('selected');
                        if(s<=5) btn.classList.add('selected-low');
                    }
                }
            });
        } 
        // Apply Team Scores
        else if (currentTab === 'team' && teamData) {
            teamData.averages.forEach((avg, idx) => {
                const rounded = Math.round(avg); // Highlight closest integer
                if(rounded >= 1 && rounded <= 10) {
                    const btn = document.getElementById(`btn-${idx}-${rounded}`);
                    if(btn) btn.classList.add('team-avg-highlight');
                }
            });
        }
    }

    // --- Tab Switching ---
    window.switchTab = (tab) => {
        currentTab = tab;
        document.getElementById('tabMy').className = tab === 'my' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tabTeam').className = tab === 'team' ? 'tab-btn active' : 'tab-btn';

        const inputs = document.querySelectorAll('input, textarea');
        const calcBtn = document.getElementById('btnCalculate');
        const uploadBtn = document.getElementById('btnUpload');
        const saveImgBtn = document.getElementById('btnSaveImg');

        if(tab === 'team') {
            // Read Only Mode
            inputs.forEach(el => el.disabled = true);
            container.style.opacity = '0.8';
            calcBtn.style.display = 'none';
            uploadBtn.style.display = 'none';
            saveImgBtn.style.display = 'none';
            document.getElementById('btnAddComment').style.display = 'none';
            
            // Show Team Result
            if(teamData) {
                const res = calculateScoreInternal(teamData.averages);
                showResult(res, true); // true = isTeam
            } else {
                resultSection.style.display = 'none';
            }
        } else {
            // Edit Mode
            inputs.forEach(el => el.disabled = false);
            container.style.opacity = '1';
            resetToUncalculatedState();
        }
        updateUIFromScores();
    };

    // --- Calculation ---

    window.calculateLocalResult = () => {
        if(myScores.includes(null)) { alert("请先完成所有维度打分"); return; }
        const res = calculateScoreInternal(myScores);
        showResult(res, false);
        
        // Show next actions
        document.getElementById('btnCalculate').style.display = 'none';
        document.getElementById('btnAddComment').style.display = 'inline-block';
        document.getElementById('btnUpload').style.display = 'inline-block';
        document.getElementById('btnSaveImg').style.display = 'inline-block';
    };

    function calculateScoreInternal(scoreArray) {
        let total = 0;
        const weights = currentMode === 'A' ? config.weightsA : config.weightsB;
        scoreArray.forEach((score, i) => { 
            // Handle float scores from team average
            // Find closest coeff or interpolate? Let's map to closest integer for coeff
            const intScore = Math.round(score);
            const safeScore = Math.max(1, Math.min(10, intScore));
            total += weights[i] * config.coeffs[safeScore]; 
        });
        
        let grade, color, comment;
        if (total >= 85) { grade = 'S 级'; color = 'var(--grade-s)'; comment = '极具潜力！核心长板突出。'; }
        else if (total >= 68) { grade = 'A 级'; color = 'var(--grade-a)'; comment = '优秀项目。虽有短板，但值得孵化。'; }
        else if (total >= 52) { grade = 'B 级'; color = 'var(--grade-b)'; comment = '观察区。需谨慎评估。'; }
        else { grade = '淘汰'; color = 'var(--grade-f)'; comment = '核心竞争力不足。'; }
        return { total, grade, color, comment };
    }

    function showResult(res, isTeam) {
        document.getElementById('finalScore').innerText = res.total.toFixed(2);
        const badge = document.getElementById('gradeBadge');
        badge.innerText = isTeam ? `团队: ${res.grade}` : res.grade;
        badge.style.background = res.color;
        badge.style.color = (res.grade.includes('S') || res.grade.includes('A')) ? '#2c0b0e' : '#fff';
        document.getElementById('commentText').innerText = res.comment;
        document.getElementById('commentText').style.borderColor = res.color; 
        resultSection.style.display = 'block';
    }

    function resetToUncalculatedState() {
        if(currentTab === 'team') return;
        resultSection.style.display = 'none';
        document.getElementById('btnCalculate').style.display = 'block';
        document.getElementById('btnAddComment').style.display = 'none';
        document.getElementById('btnUpload').style.display = 'none';
        document.getElementById('btnSaveImg').style.display = 'none';
        extraSection.style.display = 'none';
    }

    // --- Firebase Operations ---

    // 1. Load my data
    async function loadMyReview() {
        const docRef = doc(db, "projects", currentProject, "reviews", currentUser);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            myScores = data.scores;
            currentMode = data.mode || 'A';
            // Restore Mode UI
            if(currentMode === 'A') {
                document.getElementById('switchBg').style.transform = 'translateX(0)';
                document.getElementById('btnA').classList.add('active');
                document.getElementById('btnB').classList.remove('active');
            } else {
                document.getElementById('switchBg').style.transform = 'translateX(100%)';
                document.getElementById('btnA').classList.remove('active');
                document.getElementById('btnB').classList.add('active');
            }
            
            // Restore Text
            data.comments.forEach((txt, i) => { if(i<7) document.getElementById(`dim-input-${i}`).value = txt; });
            document.getElementById('extra-pros').value = data.extra.pros || "";
            document.getElementById('extra-cons').value = data.extra.cons || "";
            document.getElementById('extra-conclusion').value = data.extra.conclusion || "";
            document.getElementById('extra-questions').value = data.extra.questions || "";

            updateUIFromScores();
            alert(`欢迎回来，${currentUser}！已加载你之前的评分。`);
        }
    }

    // 2. Upload Data
    window.uploadToCloud = async () => {
        const btn = document.getElementById('btnUpload');
        btn.innerText = "上传中...";
        btn.disabled = true;

        try {
            // Gather all data
            const dimComments = [];
            for(let i=0; i<7; i++) dimComments.push(document.getElementById(`dim-input-${i}`).value);
            
            const extraData = {
                pros: document.getElementById('extra-pros').value,
                cons: document.getElementById('extra-cons').value,
                conclusion: document.getElementById('extra-conclusion').value,
                questions: document.getElementById('extra-questions').value
            };

            const reviewData = {
                user: currentUser,
                scores: myScores,
                mode: currentMode,
                comments: dimComments,
                extra: extraData,
                updatedAt: serverTimestamp()
            };

            // Write Review
            await setDoc(doc(db, "projects", currentProject, "reviews", currentUser), reviewData);

            // Trigger Aggregation (Client-side simple aggregation)
            await aggregateProjectData();

            btn.innerText = "✅ 已保存";
            setTimeout(() => { btn.innerText = "☁️ 提交到云端"; btn.disabled = false; }, 2000);

        } catch (e) {
            console.error(e);
            alert("上传失败: " + e.message);
            btn.innerText = "❌ 重试";
            btn.disabled = false;
        }
    };

    // 3. Aggregate Data (Fetch all reviews -> Calc Avg -> Update Project)
    async function aggregateProjectData() {
        const reviewsSnapshot = await getDocs(collection(db, "projects", currentProject, "reviews"));
        let count = 0;
        let sums = [0,0,0,0,0,0,0];
        
        reviewsSnapshot.forEach(doc => {
            const s = doc.data().scores;
            if(s && s.length === 7) {
                count++;
                s.forEach((val, i) => sums[i] += val);
            }
        });

        if(count > 0) {
            const averages = sums.map(s => s / count);
            const totalAvg = calculateScoreInternal(averages).total;

            await setDoc(doc(db, "projects", currentProject), {
                name: currentProject,
                reviewCount: count,
                averages: averages,
                totalAvg: totalAvg,
                lastUpdate: serverTimestamp()
            }, { merge: true });
        }
    }

    // 4. Listen for Team Data
    function listenTeamData() {
        onSnapshot(doc(db, "projects", currentProject), (doc) => {
            if(doc.exists()) {
                teamData = doc.data();
                // Update UI hints
                teamData.averages.forEach((avg, i) => {
                    document.getElementById(`team-avg-${i}`).innerText = `均分: ${avg.toFixed(1)}`;
                });
            }
        });
    }

    // --- Helpers ---
    window.toggleExtraSection = () => {
        extraSectionVisible = !extraSectionVisible;
        document.getElementById('extraSection').style.display = extraSectionVisible ? 'block' : 'none';
    };

    window.toggleMode = () => {
        if(currentTab === 'team') return;
        currentMode = (currentMode === 'A') ? 'B' : 'A';
        const switchBg = document.getElementById('switchBg');
        if(currentMode === 'A') {
            switchBg.style.transform = 'translateX(0)';
            document.getElementById('btnA').classList.add('active'); document.getElementById('btnB').classList.remove('active');
        } else {
            switchBg.style.transform = 'translateX(100%)';
            document.getElementById('btnA').classList.remove('active'); document.getElementById('btnB').classList.add('active');
        }
        resetToUncalculatedState();
    };

    // Attach to window for HTML access
    window.saveImage = () => {
        // Simple HTML2Canvas Wrapper (Simplified from v5.0 to focus on core logic)
        // If v5.0 specific hiding logic is needed, paste the saveImage function from v5.1 here.
        // For brevity, using basic capture.
        html2canvas(document.getElementById('captureTarget'), { backgroundColor: '#1e1e24', scale: 2 }).then(c => {
            const a = document.createElement('a'); a.download = `${currentProject}_评估.png`; a.href = c.toDataURL(); a.click();
        });
    };

</script>
</body>
</html>
